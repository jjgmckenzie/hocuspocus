{"version":3,"file":"hocuspocus-webhook.cjs","sources":["../src/index.ts"],"sourcesContent":["import { createHmac } from 'crypto'\nimport {\n  Extension,\n  onChangePayload,\n  onConnectPayload,\n  onLoadDocumentPayload,\n  onDisconnectPayload,\n} from '@hocuspocus/server'\nimport { Doc } from 'yjs'\nimport { TiptapTransformer, Transformer } from '@hocuspocus/transformer'\nimport axios from 'axios'\nimport { Forbidden } from '@hocuspocus/common'\n\nexport enum Events {\n  onChange = 'change',\n  onConnect = 'connect',\n  onCreate = 'create',\n  onDisconnect = 'disconnect',\n}\n\nexport interface Configuration {\n  debounce: number | false | null,\n  debounceMaxWait: number,\n  secret: string,\n  transformer: Transformer | {\n    toYdoc: (document: any) => Doc,\n    fromYdoc: (document: Doc) => any,\n  },\n  url: string,\n  events: Array<Events>,\n}\n\nexport class Webhook implements Extension {\n\n  configuration: Configuration = {\n    debounce: 2000,\n    debounceMaxWait: 10000,\n    secret: '',\n    transformer: TiptapTransformer,\n    url: '',\n    events: [\n      Events.onChange,\n    ],\n  }\n\n  debounced: Map<string, { timeout: NodeJS.Timeout, start: number }> = new Map()\n\n  /**\n   * Constructor\n   */\n  constructor(configuration?: Partial<Configuration>) {\n    this.configuration = {\n      ...this.configuration,\n      ...configuration,\n    }\n\n    if (!this.configuration.url) {\n      throw new Error('url is required!')\n    }\n  }\n\n  /**\n   * Create a signature for the response body\n   */\n  createSignature(body: string): string {\n    const hmac = createHmac('sha256', this.configuration.secret)\n\n    return `sha256=${hmac.update(body).digest('hex')}`\n  }\n\n  /**\n   * debounce the given function, using the given identifier\n   */\n  debounce(id: string, func: Function) {\n    const old = this.debounced.get(id)\n    const start = old?.start || Date.now()\n\n    const run = () => {\n      this.debounced.delete(id)\n      func()\n    }\n\n    if (old?.timeout) clearTimeout(old.timeout)\n    if (Date.now() - start >= this.configuration.debounceMaxWait) return run()\n\n    this.debounced.set(id, {\n      start,\n      timeout: setTimeout(run, <number> this.configuration.debounce),\n    })\n  }\n\n  /**\n   * Send a request to the given url containing the given data\n   */\n  async sendRequest(event: Events, payload: any) {\n    const json = JSON.stringify({ event, payload })\n\n    return axios.post(\n      this.configuration.url,\n      json,\n      { headers: { 'X-Hocuspocus-Signature-256': this.createSignature(json), 'Content-Type': 'application/json' } },\n    )\n  }\n\n  /**\n   * onChange hook\n   */\n  async onChange(data: onChangePayload) {\n    if (!this.configuration.events.includes(Events.onChange)) {\n      return\n    }\n\n    const save = () => {\n      try {\n        this.sendRequest(Events.onChange, {\n          document: this.configuration.transformer.fromYdoc(data.document),\n          documentName: data.documentName,\n          context: data.context,\n          requestHeaders: data.requestHeaders,\n          requestParameters: Object.fromEntries(data.requestParameters.entries()),\n        })\n      } catch (e) {\n        console.error(`Caught error in extension-webhook: ${e}`)\n      }\n    }\n\n    if (!this.configuration.debounce) {\n      return save()\n    }\n\n    this.debounce(data.documentName, save)\n  }\n\n  /**\n   * onLoadDocument hook\n   */\n  async onLoadDocument(data: onLoadDocumentPayload) {\n    if (!this.configuration.events.includes(Events.onCreate)) {\n      return\n    }\n\n    try {\n      const response = await this.sendRequest(Events.onCreate, {\n        documentName: data.documentName,\n        requestHeaders: data.requestHeaders,\n        requestParameters: Object.fromEntries(data.requestParameters.entries()),\n      })\n\n      if (response.status !== 200 || !response.data) return\n\n      const document = typeof response.data === 'string'\n        ? JSON.parse(response.data)\n        : response.data\n\n      // eslint-disable-next-line guard-for-in,no-restricted-syntax\n      for (const fieldName in document) {\n        if (data.document.isEmpty(fieldName)) {\n          data.document.merge(\n            this.configuration.transformer.toYdoc(document[fieldName], fieldName),\n          )\n        }\n      }\n    } catch (e) {\n      console.error(`Caught error in extension-webhook: ${e}`)\n    }\n  }\n\n  /**\n   * onConnect hook\n   */\n  async onConnect(data: onConnectPayload) {\n    if (!this.configuration.events.includes(Events.onConnect)) {\n      return\n    }\n\n    try {\n      const response = await this.sendRequest(Events.onConnect, {\n        documentName: data.documentName,\n        requestHeaders: data.requestHeaders,\n        requestParameters: Object.fromEntries(data.requestParameters.entries()),\n      })\n\n      return typeof response.data === 'string' && response.data.length > 0\n        ? JSON.parse(response.data)\n        : response.data\n    } catch (e) {\n      console.error(`Caught error in extension-webhook: ${e}`)\n      throw Forbidden\n    }\n  }\n\n  async onDisconnect(data: onDisconnectPayload) {\n    if (!this.configuration.events.includes(Events.onDisconnect)) {\n      return\n    }\n\n    try {\n      await this.sendRequest(Events.onDisconnect, {\n        documentName: data.documentName,\n        requestHeaders: data.requestHeaders,\n        requestParameters: Object.fromEntries(data.requestParameters.entries()),\n        context: data.context,\n      })\n    } catch (e) {\n      console.error(`Caught error in extension-webhook: ${e}`)\n    }\n  }\n\n}\n"],"names":["Events","TiptapTransformer","createHmac","axios","Forbidden"],"mappings":"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"}